---
title: 2022w微信大数据挑战赛Top方案总结
tags:
- 比赛
- 多模态
categories:
- 比赛
---
上周微信大数据挑战赛的决赛结束了，自己之前也投入了不少的时间来做，所以还是需要好好学习一下决赛的方案
<a name="wCpG0"></a>
# 赛题介绍

- 赛题名称：多模态短视频分类
- 赛题链接：[微信大数据挑战赛](https://algo.weixin.qq.com/)
- 数据
   - 10w有标注数据（包含视频类别）
   - 100w无标注数据
   - 每条数据包含短视频的：标题/OCR/ASR文本，32帧视频图像（初赛为抽取的特征，复赛为原始视频图像）

![image.png](https://cdn.nlark.com/yuque/0/2022/png/764062/1663962743344-48189f70-eb1c-43a8-a117-7e005af137c8.png#clientId=u04545e1a-2ebf-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=342&id=ufedde171&margin=%5Bobject%20Object%5D&name=image.png&originHeight=684&originWidth=1672&originalType=binary&ratio=1&rotation=0&showTitle=false&size=62398&status=done&style=none&taskId=ucf3d64e5-261c-4b9f-94f8-5c573ed8fe6&title=&width=836)

- 预测任务：预测每个视频所属的子类别，一共200类
- 评价指标：一二级分类F1的micro和macro平均值
- 决赛回放：[2022中国高校计算机大赛——微信大数据挑战赛决赛-CSDN直播](https://live.csdn.net/room/wl5875/Z7h0CxuN)
<a name="sVF9i"></a>
# 1st 苟进决赛
<a name="V4Xbk"></a>
## 模型架构
采用三种模型架构进行融合：

- 模型一：单流架构，文本过embedding层，视频过clip的vit，然后拼接起来送入bert，最后mean pooing后接分类层
- 模型二，双流架构，文本过bert，视频过clip，然后将视频向量和文本向量拼接起来，再过一个transformer，mean pooing后接分类层
- 模型三，双流架构，文本过bert，视频过clip，得到视频向量和文本向量，然后做cross attention,即对于视频向量，用文本向量作为Q进行注意力加权，而对于文本向量，用视频向量作为Q进行注意力加权，最后mean pooing后接分类层

![image.png](https://cdn.nlark.com/yuque/0/2022/png/764062/1663636603759-8daf9518-86ba-42a1-b1e5-06c6472a1a65.png#clientId=ua1e5a05c-66ec-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=557&id=u09c940ec&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1114&originWidth=2698&originalType=binary&ratio=1&rotation=0&showTitle=false&size=462998&status=done&style=none&taskId=ua4ba0bc2-5233-49e4-bea0-3f8f45fa82e&title=&width=1349)<br />其他选手的模型架构基本也都是这三种的一种，之后就不详细展开
<a name="j5Snx"></a>
## 预训练任务

1. MLM（Mask languge model）：输入时随机mask掉一个文本，预测被mask掉的文本
2. VTM (Video text match)：输入时以50%概率随机采样替换掉一个视频，然后预测这个视频是不是原来的视频，即输入的文本是否与视频匹配
3. ICT (Inverse Cloze Task)：文本包含标题、OCR,ASR，随机取一段作为query，其余的作为condidate，做对比学习
4. SimCSE：对于一个文本输入，经过两次dropout后作为正样本，其他文本作为负样本，进行对比学习
<a name="xHRcQ"></a>
## 其他技巧

1. 知识蒸馏

这部分应该是整个方案的核心亮点了，也是拉开和后面几位差距的关键点。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/764062/1663656074613-070c60d0-f475-48d5-9289-8b41c26aedac.png#clientId=ua1e5a05c-66ec-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=460&id=u5dee590d&margin=%5Bobject%20Object%5D&name=image.png&originHeight=919&originWidth=2724&originalType=binary&ratio=1&rotation=0&showTitle=false&size=328607&status=done&style=none&taskId=u2d47d71c-ae92-4443-a982-8067e59dc89&title=&width=1362)<br />具体步骤应该是：

1. 在标注数据上，训练更长（32帧）的帧和更大（CLIP-Large）更多（ensemble）的模型
2. 使用1得到的模型为无标注数据打伪标签，得到一份带伪标签的无标注数据
3. 在2得到的这份数据上进行预训练，预训练任务包含伪标签预测以及之前提到的那4个，预训练时随机使用5/32帧的视频，以缓解预训练和微调过程的不一致性
4. 重复2和3步骤，将最后得到的模型用来做下一步微调模型的初始化
5. 在有标注数据上进行微调，得到最终预测结果
<a name="ZJl8y"></a>
## 亮点

1. 伪标签知识蒸馏，直接提了两个百分点，还是很厉害的
<a name="aS6ll"></a>
# 2nd 冲冲冲
<a name="LPCcV"></a>
## 模型架构
就是一个普通的单流架构，不过引入了Memory Bank来缓解batchsize过小导致预训练效果差的问题<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/764062/1663641177228-b70ef751-32e0-4710-b00f-cc5b13b63625.png#clientId=ua1e5a05c-66ec-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=414&id=u987683bc&margin=%5Bobject%20Object%5D&name=image.png&originHeight=828&originWidth=1475&originalType=binary&ratio=1&rotation=0&showTitle=false&size=507248&status=done&style=none&taskId=u6f4c191e-6ea1-491c-bac2-edaca28c97d&title=&width=737.5)
<a name="IdPl2"></a>
## 预训练任务

1. MLM
2. MMA（Multi-modal Alignment）：最特色的地方，在对比学习时引入了三类共六个的任务，使得模态间信息更加对齐，并且在训练时随机丢弃一个模态，以缓解模态缺失的问题，并加快训练

![image.png](https://cdn.nlark.com/yuque/0/2022/png/764062/1663699381018-1de11cd0-658e-4ec8-9efa-38427ea34eea.png#clientId=ua1e5a05c-66ec-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=613&id=u876d1188&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1226&originWidth=2671&originalType=binary&ratio=1&rotation=0&showTitle=false&size=575987&status=done&style=none&taskId=ufccfd26b-dbb2-4449-9c8c-9a6b7c9c322&title=&width=1335.5)
<a name="T7mpQ"></a>
## 其他技巧

1. EMA
2. Label smoothing
3. Rdrop
4. Class Balanced Loss

![image.png](https://cdn.nlark.com/yuque/0/2022/png/764062/1663699534745-92784cb8-5a4f-4836-8e5a-d29958670998.png#clientId=ua1e5a05c-66ec-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=78&id=u77b1889e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=156&originWidth=794&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38890&status=done&style=none&taskId=ufe5e77b4-57c1-4880-ad16-52df2dc170c&title=&width=397)

5. 模型加速
   1. 图片解码加速，GPU预处理加速
   2. TensorRT + 数据并行 + 共享内存
   3. FP16推理 + 分桶预测 + 多进程模型并行
6. 伪标签：用10万有标记样本，训练DML模型并提取特征，然后用无标记数据检索有标记数据，用Top10样本进行类目投票，这里生成伪标签跟其他选手用的方案不一样，不是直接预测，而是用检索的方式来生成，也算一大特色
<a name="dnatb"></a>
## 亮点

1. 预训练的MMA任务
2. 伪标签用检索的方式生成
<a name="T5K4L"></a>
# 3rd 抱朴子
<a name="Z8Jah"></a>
## 模型架构
这组一共用了5个模型，双流的三个模型共用编码器，编码器采用中文预训练的R2D2的Roberta-base和VIT-large，具体每个模型的架构也都和第一名提到的三个没太大差别<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/764062/1663700198529-3017edd9-c156-4887-ba1d-06926cc3550e.png#clientId=ua1e5a05c-66ec-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=638&id=u548daa6a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1276&originWidth=1955&originalType=binary&ratio=1&rotation=0&showTitle=false&size=183162&status=done&style=none&taskId=uecf60a59-f745-41ea-adfc-15b7a47e2c5&title=&width=977.5)<br />单流架构的Alpro应该是先把文本过6层的transformer后再和视频特征拼起来送入后6层<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/764062/1663700469412-44c0019e-94a7-41be-b026-4dfd820df250.png#clientId=ua1e5a05c-66ec-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=447&id=ude6fd0f7&margin=%5Bobject%20Object%5D&name=image.png&originHeight=894&originWidth=1820&originalType=binary&ratio=1&rotation=0&showTitle=false&size=111335&status=done&style=none&taskId=u344be838-fa37-4d01-9269-9478cfcc1fe&title=&width=910)<br />双流架构一个使用cross-encoder的方式，另外两个用了cross-attention，这两个的差别在于处理视频向量时一个采用视频patch聚合另一个采用视频帧之间平均<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/764062/1663700522791-ddd1a1da-3b2d-4c54-9be6-65def1971554.png#clientId=ua1e5a05c-66ec-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=286&id=u54d71ecd&margin=%5Bobject%20Object%5D&name=image.png&originHeight=571&originWidth=2272&originalType=binary&ratio=1&rotation=0&showTitle=false&size=115170&status=done&style=none&taskId=ue38ae86f-b960-44c3-ba8c-e1f7c77ab96&title=&width=1136)
<a name="w2tM4"></a>
## 预训练任务

1. MLM
2. VTM
3. MFM (mask frame model)：随机mask掉一个帧，然后在输出时还原对应的帧
<a name="W3Xfo"></a>
## 其他技巧

1. EMA, FGM等
2. TensorRT优化加速
<a name="xSJB8"></a>
## 亮点

1. 文本和视频编码器用的中文预训练模型R2D2
<a name="pOEsX"></a>
# 3rd 机器不学习啦
<a name="VHyZI"></a>
## 模型架构
使用双流的ALBEF架构，视频过clip，文本过六层的bert，最后在后六层的bert做交互。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/764062/1663934670257-6c1329f4-1f4e-43e0-a750-3b8ac38771a6.png#clientId=u47c39a7c-ef19-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=476&id=ub70c7338&margin=%5Bobject%20Object%5D&name=image.png&originHeight=951&originWidth=924&originalType=binary&ratio=1&rotation=0&showTitle=false&size=99115&status=done&style=none&taskId=u5ac6e148-dbe6-4c5a-a264-7b698804b8e&title=&width=462)
<a name="OejXd"></a>
## 预训练任务

1. MLM
2. MFM
3. VTA: 输出层前的视频向量和文本向量mean pool后用infoCSE做对比学习

![image.png](https://cdn.nlark.com/yuque/0/2022/png/764062/1663934859662-ad03421c-eb7b-48e2-bbe3-b0a48a1ffd16.png#clientId=u47c39a7c-ef19-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=385&id=uae51d491&margin=%5Bobject%20Object%5D&name=image.png&originHeight=770&originWidth=970&originalType=binary&ratio=1&rotation=0&showTitle=false&size=80080&status=done&style=none&taskId=uc06d7f22-ea83-4bf8-b475-e48d6ef653a&title=&width=485)
<a name="UvR1C"></a>
## 其他技巧

1. 多任务finetune

这个队伍finetune时还用了多任务，除了正常的分类头，还给视觉编码器后面添加了一个分类头，还有加了一个对比学习的任务：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/764062/1663959623942-972f9aff-7364-43ed-a5e9-fdd81c6140ed.png#clientId=u47c39a7c-ef19-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=379&id=u33f7d946&margin=%5Bobject%20Object%5D&name=image.png&originHeight=757&originWidth=750&originalType=binary&ratio=1&rotation=0&showTitle=false&size=73800&status=done&style=none&taskId=ud967cd6e-b229-4f3a-9cf6-4672d4523a7&title=&width=375)<br />具体loss形式为：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/764062/1663959707174-17d4adb1-ee8d-4045-84f7-9db8fc27833a.png#clientId=u47c39a7c-ef19-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=65&id=u3a663643&margin=%5Bobject%20Object%5D&name=image.png&originHeight=129&originWidth=1854&originalType=binary&ratio=1&rotation=0&showTitle=false&size=73126&status=done&style=none&taskId=u02446e53-18b3-4582-b8b2-3cec33e937a&title=&width=927)

2. 训练技巧：EMA, R-drop
3. 针对长尾问题，单独训练更强的尾部类别分类器，并进行集成
4. 模型加速：TensorRT-FP16加速ViT-B/16 + Torch-FP16加速其他模块，多模型共用视觉特征，并行
<a name="Ms9Ve"></a>
## 亮点

1. 多任务finetune，这个居然能取得不错的结果
2. 针对长尾问题单独训练分类器
<a name="y8og2"></a>
# 5th warriors
<a name="HMLEE"></a>
## 模型架构
单流架构，不过针对视频特征和文本特征单独进行mean pooling后再进行一次mean pooling<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/764062/1663960085419-374cbdf9-f964-4395-a14f-6aec0e526b08.png#clientId=u47c39a7c-ef19-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=546&id=u2df1793f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1092&originWidth=1510&originalType=binary&ratio=1&rotation=0&showTitle=false&size=131280&status=done&style=none&taskId=ucd3b0fb8-d643-4cd2-8466-75348555dcf&title=&width=755)
<a name="pkgQv"></a>
## 预训练任务

1. MLM
2. MFM
3. VTA
4. VTM
<a name="TBLri"></a>
## 其他技巧

1. 使用词粒度的分词方案使得序列变短，处理速度更快，并且和字粒度的方案融合
2. 针对类别不均衡对小于200个类别重采样， 对无标签数据打伪标签，根据类别数量进行不均衡采样，加入训练集
3. 训练技巧：FGM, label smoothing
4. 加速：混合精度训练，Fp16推理
<a name="QHgR1"></a>
## 亮点

1. 分别对视频和文本进行mean pooing
2. 使用了词粒度的分词方案
<a name="nJmhz"></a>
# 6th 蜜度信息
<a name="M9A9S"></a>
## 模型架构
一个单流模型，不过最后时生成了四个pooling送入线性分类层<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/764062/1663960515768-1ed8f970-f469-45ca-907e-23878ccf8afa.png#clientId=u47c39a7c-ef19-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=625&id=u0a9d3046&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1250&originWidth=2791&originalType=binary&ratio=1&rotation=0&showTitle=false&size=473620&status=done&style=none&taskId=u62807e18-888d-4342-8170-4c9048eed3d&title=&width=1395.5)<br />一个双流模型:<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/764062/1663960585819-8b1f57a6-f9d0-4144-b2d1-8e76a9ba9dbb.png#clientId=u47c39a7c-ef19-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=479&id=u92764a6e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=957&originWidth=1321&originalType=binary&ratio=1&rotation=0&showTitle=false&size=99035&status=done&style=none&taskId=u691cb9f3-a5da-43c4-ae30-7d16556c47c&title=&width=660.5)<br />这里双流模型和别的选手不同的地方是他们做了很多手工的特征拼接进来，具体包括：

- 视频第一帧的embedding
- Nextvlad特征
- Netvlad特征
- Netrvlad特征
- Softdbow特征
- Netfv特征
- Bottleneck fusion融合特征
- 帧相似度（shift 1 frame）
- 帧相似度（shift 2 frame）
- 帧相似度（shift 3 frame）
<a name="S8lEF"></a>
## 预训练任务

1. MLM（单流、双流）
2. VTM（单流）
3. VTA（单流）
4. MFM（双流）
5. First Image Prediction（双流）: 这个是其他选手没有的，他们认为第一张图片很重要，于是加了一个这样的任务，让模型能够还原出第一帧的图片
6.  单模态-交叉模态 CLIP（双流）：在交叉模态融合前与融合后，分别做CLIP loss
7. Caption（双流）： 使用融合过的多模态hidden当做encoder output， 来对拼接后的text inputs做解码预测
<a name="OCRul"></a>
## 其他技巧

1. 训练技巧：对抗训练（预训练和finetune阶段都用了）
2. 概率后处理：具体做法是 1/value_count,每个类别得到一个放大的概率值，大类是1，小类>1
3. 模型加速：BF16加速训练，FP16加速推理
4. 伪标签
<a name="ZSuRL"></a>
## 亮点

1. 加入了很多手工特征，拼接到模型中
2. 设计了多种独特的预训练任务
3. 后处理
<a name="lBDgU"></a>
# 总结
总结一下六个队伍方案的基本都有用到的的东西，抽象出一套有效的方案：

1. 模型架构上：单流、双流的各种架构都可以，融合起来更好
2. 模型backbone：文本编码器用macbert或roberta，视觉编码器用clip的vit（这个尤为重要，因为是多模态的预训练模型，据说比swin高两个百分点，而且最好用large，冻结训练）
3. 预训练任务：MLM、MFM、VTM、VTA等
4. 训练技巧：FGM、EMA、Rdrop、label smoothing
5. 类别不平衡处理：这个处理方式就多种多样，可以改CE loss的权重，也可以对类别少的样本过采样，从伪标签中生成，也可以后处理类别少的概率、训练单独分类器等
6. 伪标签，可以将微调好的模型直接预测作为伪标签加入训练（蜜度信息），也可以用检索的方式投票（冲冲冲），也可以把伪标签当成一种预训练的方式（苟进决赛）
7. 加速：tensor RT, FP16推理，并行等
